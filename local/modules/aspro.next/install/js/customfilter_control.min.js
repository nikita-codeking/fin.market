function initAsproNextCustomFilterControl(t){var o=JSON.parse(t.data);o&&(window["aspro_next_customfilter_conditions_"+t.propertyID]=new AsproNextCustomFilterControl(o,t))}function AsproNextCustomFilterControl(t,o){var i=BX.util.getRandomString(5),e=this;this.params=o||{},this.message=JSON.parse(o.propertyParams.JS_MESSAGES)||{},this.data=t||{},this.nodes={},this.ids={form:"limit_cond_form_"+this.params.propertyID+"_"+i,container:"limit_cond_container_"+this.params.propertyID+"_"+i,treeObject:"limit_cond_obj_"+this.params.propertyID+"_"+i},this.path=this.getPath(),this.buildNodes(),BX.addCustomEvent("onTreeConditionsInit",BX.proxy(this.modifyTreeParams,this)),BX.addCustomEvent("onAdminTabsDeleteLevel",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onNextVisualChange",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onTreeCondPopupClose",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onTreeCondDialogSave",BX.proxy(function(t){var o=this;setTimeout(function(){o.onChangeForm()},100)},this)),BX.loadScript("/bitrix/js/catalog/core_tree.js",function(){BX.ajax({timeout:60,method:"POST",dataType:"html",url:e.path,data:{action:"init",data:e.data,property:{id:e.params.propertyParams.ID,iblockId:e.params.propertyParams.IBLOCK_ID},condition:e.params.oInput.value,ids:e.ids,sessid:BX.bitrix_sessid()},onsuccess:BX.proxy(this.saveData,this)})}),BX.loadCSS("/bitrix/panel/catalog/catalog_cond.css")}AsproNextCustomFilterControl.prototype={getPath:function(){return this.params.propertyParams.AJAX_FILE},deleteFromArray:function(t,o){if(BX.type.isArray(t)&&BX.type.isArray(o))for(var i=o.length;--i;)o[i]&&o.hasOwnProperty(i)&&BX.util.in_array(i,t)&&o.splice(i,1)},onChangeForm:function(){this.nodes.form&&BX.fireEvent(this.nodes.form,"change")},modifyTreeParams:function(t,o,i){if(i&&t.formName===this.ids.form){var e,a,s=[];for(e in i)i.hasOwnProperty(e)&&((a=i[e]).group?this.modifyCondGroup(a):this.modifyCondValueGroup(a)&&s.push(e));this.deleteFromArray(s,i)}},modifyCondGroup:function(t){var o;if(t.visual)for(o in t.visual.values)t.visual.values.hasOwnProperty(o)&&"False"===t.visual.values[o].True&&(t.visual.values.splice(o,1),t.visual.logic.splice(o,1));if(t.control)for(o in t.control)t.control.hasOwnProperty(o)&&(t.control[o].dontShowFirstOption=!0,"True"===t.control[o].id&&delete t.control[o].values.False)},modifyCondValueGroup:function(t){if(t&&t.children&&t.children.length){var o,i,e,a=["CondIBXmlID","CondIBIBlock","CondIBCode","CondIBName","CondIBElement","CondIBSection","CondIBDateActiveFrom","CondIBDateActiveTo","CondIBSort","CondIBDateCreate","CondIBCreatedBy","CondIBTimestampX","CondIBModifiedBy","CondIBTags","CondCatQuantity","CondCatWeight"];for(var s in t.children)if(t.children.hasOwnProperty(s)){if(i=t.children[s],o=!0,BX.util.in_array(i.controlId,a))o=!1;else{if((e=i.controlId.split(":"))[1]&&e[1]!=this.data.iblockId&&e[1]!=this.data.offersIblockId)return!0;"CondIBProp"!==e[0]&&"CondCrossIBProp"!==e[0]||!e[2]||(o=!1)}o&&delete t.children[s]}return t.children=t.children.filter(function(t){return t}),!1}},buildNodes:function(){this.nodes.warning=BX.create("DIV",{props:{className:"bx-filter-conditions-warning dm-info-message-wrap adm-info-message-red"},html:'<div class="adm-info-message"><div class="adm-info-message-title">'+this.message.invalid+'</div><div class="adm-info-message-icon"></div></div>',style:{display:"none"}}),this.nodes.container=BX.create("DIV",{props:{id:this.ids.container}}),this.nodes.form=BX.create("FORM",{props:{id:this.ids.form,name:this.ids.form},children:[this.nodes.container],events:{change:BX.proxy(function(){this.saveData()},this)}}),this.params.oCont.appendChild(BX.create("DIV",{children:[this.nodes.warning,this.nodes.form]})),BX.bindDelegate(this.nodes.form,"mousedown",{className:"condition-item-del"},BX.proxy(function(){var t=this;setTimeout(function(){t.onChangeForm()},100)},this))},saveData:function(){var t={action:"save",ids:this.ids,data:this.data,property:{id:this.params.propertyParams.ID,iblockId:this.params.propertyParams.IBLOCK_ID},sessid:BX.bitrix_sessid()};BX.ajax({timeout:60,method:"POST",dataType:"json",url:this.path,data:BX.merge(this.getAllFormData(),t),onsuccess:BX.proxy(function(t){""===t?this.nodes.warning.style.display="block":(this.nodes.warning.style.display="none",this.params.oInput.value=JSON.stringify(t))},this)})},getAllFormData:function(){var t=BX.ajax.prepareForm(this.nodes.form);for(var o in t.data)t.data.hasOwnProperty(o)&&""==o&&delete t.data[o];return t&&t.data?t.data:{}}};